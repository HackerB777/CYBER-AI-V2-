import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ShieldAlert, Plus, Trash2, Search, AlertTriangle, CheckCircle, X, Check, ExternalLink } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useVulnerabilities, Vulnerability } from '@/hooks/useVulnerabilities';
import { useTargets } from '@/hooks/useTargets';
import { useAuth } from '@/hooks/useAuth';
import { toast } from 'sonner';

export const VulnerabilityDatabasePanel = () => {
  const { vulnerabilities, isLoading, addVulnerability, updateVulnerability, deleteVulnerability } = useVulnerabilities();
  const { targets } = useTargets();
  const { user } = useAuth();
  const [isAdding, setIsAdding] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [formData, setFormData] = useState({
    name: '',
    cve_id: '',
    severity: 'medium',
    description: '',
    solution: '',
    cvss_score: null as number | null,
    target_id: null as string | null,
    status: 'open'
  });

  const handleAdd = async () => {
    if (!formData.name) {
      toast.error('Vulnerability name is required');
      return;
    }

    const result = await addVulnerability(formData);
    if (result) {
      toast.success('Vulnerability added');
      setFormData({ name: '', cve_id: '', severity: 'medium', description: '', solution: '', cvss_score: null, target_id: null, status: 'open' });
      setIsAdding(false);
    }
  };

  const handleStatusToggle = async (vuln: Vulnerability) => {
    const newStatus = vuln.status === 'open' ? 'resolved' : 'open';
    await updateVulnerability(vuln.id, { status: newStatus });
    toast.success(`Vulnerability marked as ${newStatus}`);
  };

  const getSeverityColor = (severity: string) => {
    switch (severity.toLowerCase()) {
      case 'critical': return 'text-destructive bg-destructive/20';
      case 'high': return 'text-orange-400 bg-orange-400/20';
      case 'medium': return 'text-accent bg-accent/20';
      case 'low': return 'text-primary bg-primary/20';
      default: return 'text-muted-foreground bg-muted';
    }
  };

  const filteredVulns = vulnerabilities.filter(v =>
    v.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    v.cve_id?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    v.description?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  if (!user) {
    return (
      <section className="py-8 px-4">
        <div className="container mx-auto text-center text-muted-foreground">
          Please log in to view vulnerabilities
        </div>
      </section>
    );
  }

  return (
    <section className="py-8 px-4">
      <div className="container mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <ShieldAlert className="w-6 h-6 text-destructive" />
            <h2 className="text-xl font-mono text-destructive">VULNERABILITY DATABASE</h2>
          </div>
          <div className="flex items-center gap-3">
            <div className="relative">
              <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" />
              <Input
                placeholder="Search CVE, name..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9 w-64 bg-background"
              />
            </div>
            <Button variant="outline" size="sm" onClick={() => setIsAdding(true)} className="gap-2">
              <Plus className="w-4 h-4" /> Add Vulnerability
            </Button>
          </div>
        </div>

        <AnimatePresence>
          {isAdding && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="mb-4 p-4 border border-border rounded-lg bg-card"
            >
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <Input
                  placeholder="Vulnerability Name *"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  className="bg-background"
                />
                <Input
                  placeholder="CVE ID (e.g., CVE-2024-1234)"
                  value={formData.cve_id}
                  onChange={(e) => setFormData({ ...formData, cve_id: e.target.value })}
                  className="bg-background"
                />
                <select
                  value={formData.severity}
                  onChange={(e) => setFormData({ ...formData, severity: e.target.value })}
                  className="px-3 py-2 rounded-md border border-border bg-background text-foreground"
                >
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                <Input
                  placeholder="Description"
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  className="bg-background"
                />
                <Input
                  placeholder="Solution/Remediation"
                  value={formData.solution}
                  onChange={(e) => setFormData({ ...formData, solution: e.target.value })}
                  className="bg-background"
                />
              </div>
              <div className="flex gap-2">
                <Button size="sm" onClick={handleAdd} className="gap-2">
                  <Check className="w-4 h-4" /> Save
                </Button>
                <Button size="sm" variant="ghost" onClick={() => setIsAdding(false)}>
                  <X className="w-4 h-4" /> Cancel
                </Button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        <div className="grid gap-3">
          {isLoading ? (
            <div className="text-center text-muted-foreground py-8">Loading vulnerabilities...</div>
          ) : filteredVulns.length === 0 ? (
            <div className="text-center text-muted-foreground py-8">
              {searchQuery ? 'No vulnerabilities match your search' : 'No vulnerabilities recorded'}
            </div>
          ) : (
            filteredVulns.map((vuln) => (
              <motion.div
                key={vuln.id}
                layout
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                className={`p-4 border rounded-lg transition-colors ${
                  vuln.status === 'resolved' ? 'border-primary/30 bg-primary/5' : 'border-destructive/30 bg-card/50'
                }`}
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      {vuln.status === 'resolved' ? (
                        <CheckCircle className="w-5 h-5 text-primary" />
                      ) : (
                        <AlertTriangle className="w-5 h-5 text-destructive" />
                      )}
                      <span className="font-mono font-semibold text-foreground">{vuln.name}</span>
                      <span className={`px-2 py-0.5 rounded text-xs font-mono uppercase ${getSeverityColor(vuln.severity)}`}>
                        {vuln.severity}
                      </span>
                      {vuln.cve_id && (
                        <a
                          href={`https://nvd.nist.gov/vuln/detail/${vuln.cve_id}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-xs text-accent hover:underline flex items-center gap-1"
                        >
                          {vuln.cve_id} <ExternalLink className="w-3 h-3" />
                        </a>
                      )}
                      {vuln.cvss_score && (
                        <span className="text-xs text-muted-foreground">CVSS: {vuln.cvss_score}</span>
                      )}
                    </div>
                    {vuln.description && (
                      <p className="text-sm text-muted-foreground mb-2">{vuln.description}</p>
                    )}
                    {vuln.solution && (
                      <p className="text-sm text-primary">ðŸ’¡ {vuln.solution}</p>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <Button
                      size="sm"
                      variant={vuln.status === 'resolved' ? 'outline' : 'default'}
                      onClick={() => handleStatusToggle(vuln)}
                    >
                      {vuln.status === 'resolved' ? 'Reopen' : 'Resolve'}
                    </Button>
                    <Button size="icon" variant="ghost" onClick={() => deleteVulnerability(vuln.id)}>
                      <Trash2 className="w-4 h-4 text-destructive" />
                    </Button>
                  </div>
                </div>
              </motion.div>
            ))
          )}
        </div>

        {/* Stats */}
        <div className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
          {['critical', 'high', 'medium', 'low'].map((sev) => {
            const count = vulnerabilities.filter(v => v.severity === sev && v.status === 'open').length;
            return (
              <div key={sev} className={`p-3 rounded-lg border border-border bg-card/50 text-center`}>
                <div className={`text-2xl font-mono font-bold ${getSeverityColor(sev).split(' ')[0]}`}>{count}</div>
                <div className="text-xs text-muted-foreground uppercase">{sev} Open</div>
              </div>
            );
          })}
        </div>
      </div>
    </section>
  );
};
